# GDPR Webhook Testing Guide

This guide explains how to test all GDPR mandatory webhooks before submitting your app to the Shopify App Store.

## Prerequisites

Before testing, ensure:
- ‚úÖ Database migration has been run (`npx prisma migrate deploy` in production)
- ‚úÖ Webhooks are registered with Shopify (`shopify app deploy`)
- ‚úÖ App is deployed to Vercel (or your hosting provider)
- ‚úÖ You have Shopify CLI installed and authenticated

## Testing Environment Setup

### Option 1: Test in Development (Recommended First)

```bash
# Start local development server
shopify app dev

# The CLI will create a tunnel and register webhooks automatically
# Keep this terminal window open
```

### Option 2: Test in Production

```bash
# Make sure you're on the correct app
shopify app config use

# Verify webhook configuration
shopify app config webhook list
```

---

## Test 1: customers/data_request Webhook

This webhook is triggered when a customer requests their data from the merchant.

### Step 1: Trigger the Webhook

```bash
shopify webhook trigger --topic customers/data_request --address https://always-receptionist.vercel.app/webhooks/customers/data_request
```

**Expected Payload** (automatically generated by CLI):
```json
{
  "shop_id": 1234567890,
  "shop_domain": "your-test-store.myshopify.com",
  "orders_requested": ["1234", "5678"],
  "customer": {
    "id": 9876543210,
    "email": "customer@example.com",
    "phone": "+1-555-0123"
  },
  "data_request": {
    "id": 12345
  }
}
```

### Step 2: Verify the Response

**Check Vercel Logs** (or your hosting logs):
```bash
# Look for these log entries:
üìã GDPR WEBHOOK: customers/data_request
Shop: your-test-store.myshopify.com
Customer ID: 9876543210
Customer Email: customer@example.com
‚úÖ GDPR request logged: [request-id]
‚úÖ Customer data collected successfully
```

### Step 3: Verify Database

Check that the GDPR request was logged:

```sql
-- Connect to your database
SELECT * FROM "GdprRequest"
WHERE "requestType" = 'data_request'
ORDER BY "createdAt" DESC
LIMIT 1;
```

**Expected Result**:
- `status` should be "completed"
- `customerEmail` should match the webhook payload
- `processedAt` should have a timestamp

### Step 4: Verify UI

1. Open your app: `https://your-store.myshopify.com/admin/apps/always-receptionist`
2. Navigate to: **GDPR Compliance** page
3. Verify you see the data request in the history table

**Pass Criteria**: ‚úÖ
- Webhook returns 200 OK
- Request logged in database
- Status shows "completed"
- Appears in compliance dashboard

---

## Test 2: customers/redact Webhook

This webhook is triggered when a merchant requests deletion of customer data.

### Step 1: Create Test Call Data

First, create some test call logs to delete:

```sql
-- Insert test call logs
INSERT INTO "CallLog" ("id", "shop", "callId", "phoneNumber", "transcript", "createdAt")
VALUES
  ('test-call-1', 'your-test-store.myshopify.com', 'call-123', '+1-555-0123', 'Test transcript 1', NOW()),
  ('test-call-2', 'your-test-store.myshopify.com', 'call-456', '+1-555-0123', 'Test transcript 2', NOW());
```

### Step 2: Trigger the Webhook

```bash
shopify webhook trigger --topic customers/redact --address https://always-receptionist.vercel.app/webhooks/customers/redact
```

**Expected Payload**:
```json
{
  "shop_id": 1234567890,
  "shop_domain": "your-test-store.myshopify.com",
  "customer": {
    "id": 9876543210,
    "email": "customer@example.com",
    "phone": "+1-555-0123"
  },
  "orders_to_redact": ["1234", "5678"]
}
```

### Step 3: Verify the Response

**Check Vercel Logs**:
```bash
üóëÔ∏è GDPR WEBHOOK: customers/redact
Customer ID: 9876543210
Customer Phone: +1-555-0123
‚úÖ Customer data redacted successfully
üóëÔ∏è Deleted 2 call logs
```

### Step 4: Verify Database

**Verify call logs were deleted**:
```sql
-- Should return 0 rows
SELECT * FROM "CallLog"
WHERE "phoneNumber" = '+1-555-0123';
```

**Verify GDPR request was logged**:
```sql
SELECT * FROM "GdprRequest"
WHERE "requestType" = 'customer_redact'
ORDER BY "createdAt" DESC
LIMIT 1;
```

**Pass Criteria**: ‚úÖ
- Webhook returns 200 OK
- Call logs for the customer are deleted
- GDPR request logged with status "completed"
- Appears in compliance dashboard

---

## Test 3: shop/redact Webhook

This webhook is triggered 48 hours after a merchant uninstalls your app.

### Step 1: Create Test Shop Data

```sql
-- Verify you have test data for the shop
SELECT
  (SELECT COUNT(*) FROM "Session" WHERE shop = 'your-test-store.myshopify.com') as sessions,
  (SELECT COUNT(*) FROM "VapiConfig" WHERE shop = 'your-test-store.myshopify.com') as configs,
  (SELECT COUNT(*) FROM "CallLog" WHERE shop = 'your-test-store.myshopify.com') as calls,
  (SELECT COUNT(*) FROM "ShopSettings" WHERE shop = 'your-test-store.myshopify.com') as settings;
```

### Step 2: Trigger the Webhook

```bash
shopify webhook trigger --topic shop/redact --address https://always-receptionist.vercel.app/webhooks/shop/redact
```

**Expected Payload**:
```json
{
  "shop_id": 1234567890,
  "shop_domain": "your-test-store.myshopify.com"
}
```

### Step 3: Verify the Response

**Check Vercel Logs**:
```bash
üóëÔ∏è GDPR WEBHOOK: shop/redact
Shop: your-test-store.myshopify.com
‚úÖ Shop data redacted successfully
üóëÔ∏è Deleted records summary:
   - Sessions: 1
   - VAPI Config: 1
   - Shop Settings: 0
   - Call Logs: 10
   - GDPR Requests: 3
```

### Step 4: Verify Database

**Verify ALL shop data was deleted**:
```sql
-- ALL of these should return 0 rows
SELECT COUNT(*) FROM "Session" WHERE shop = 'your-test-store.myshopify.com';
SELECT COUNT(*) FROM "VapiConfig" WHERE shop = 'your-test-store.myshopify.com';
SELECT COUNT(*) FROM "CallLog" WHERE shop = 'your-test-store.myshopify.com';
SELECT COUNT(*) FROM "ShopSettings" WHERE shop = 'your-test-store.myshopify.com';
SELECT COUNT(*) FROM "GdprRequest" WHERE shop = 'your-test-store.myshopify.com';
```

**Pass Criteria**: ‚úÖ
- Webhook returns 200 OK
- ALL shop data is deleted (all tables)
- No records remain for the shop
- Transaction completed atomically

---

## Test 4: app/uninstalled Webhook

This webhook is triggered immediately when a merchant uninstalls your app.

### Step 1: Test via CLI

```bash
shopify webhook trigger --topic app/uninstalled --address https://always-receptionist.vercel.app/webhooks/app/uninstalled
```

### Step 2: Verify the Response

**Check Vercel Logs**:
```bash
üì¶ WEBHOOK: app/uninstalled
Shop: your-test-store.myshopify.com
‚úÖ Shop data deleted successfully
üóëÔ∏è Deleted records summary:
   - Sessions: 1
   - VAPI Config: 1
   - Shop Settings: 0
   - Call Logs: 5
   - GDPR Requests: 2
```

### Step 3: Verify Same Behavior as shop/redact

The `app/uninstalled` webhook should delete the same data as `shop/redact` (both use `redactShopData()`).

**Pass Criteria**: ‚úÖ
- Webhook returns 200 OK
- ALL shop data is deleted
- Same behavior as shop/redact webhook

---

## Advanced Testing

### Test 5: HMAC Verification

Test that webhooks reject requests with invalid HMAC signatures:

```bash
# Send a request without proper Shopify HMAC
curl -X POST https://always-receptionist.vercel.app/webhooks/customers/data_request \
  -H "Content-Type: application/json" \
  -d '{"shop_domain": "fake-shop.myshopify.com"}'
```

**Expected**: 401 Unauthorized (Shopify SDK handles this automatically)

### Test 6: Duplicate Webhook Delivery

Shopify may send webhooks multiple times. Test idempotency:

```bash
# Send the same webhook twice
shopify webhook trigger --topic customers/redact --address https://always-receptionist.vercel.app/webhooks/customers/redact
shopify webhook trigger --topic customers/redact --address https://always-receptionist.vercel.app/webhooks/customers/redact
```

**Expected**:
- First request: Deletes data
- Second request: Returns 200 OK but logs "Already processed or no data to delete"

### Test 7: Error Handling

Test webhook behavior with database errors:

```bash
# Temporarily break database connection (set invalid DATABASE_URL)
# Then trigger webhook
shopify webhook trigger --topic customers/data_request
```

**Expected**:
- Webhook still returns 200 OK (to prevent Shopify retries)
- Error is logged in Vercel
- Status in logs shows "failed"

---

## Production Testing Checklist

Before submitting to Shopify App Store:

### Database Verification
- [ ] Run migration: `npx prisma migrate deploy` (production)
- [ ] Verify `GdprRequest` table exists
- [ ] Verify indexes are created

### Webhook Registration
- [ ] Run: `shopify app deploy`
- [ ] Verify webhooks in Partner Dashboard:
  - customers/data_request
  - customers/redact
  - shop/redact
  - app/uninstalled
  - app/scopes_update

### Functional Testing
- [ ] Test `customers/data_request` ‚Üí Returns 200 OK, logs request
- [ ] Test `customers/redact` ‚Üí Deletes customer call data
- [ ] Test `shop/redact` ‚Üí Deletes ALL shop data
- [ ] Test `app/uninstalled` ‚Üí Deletes ALL shop data

### UI Testing
- [ ] Visit `/app/compliance` page
- [ ] Verify statistics display correctly
- [ ] Verify request history table works
- [ ] Verify status badges show correct colors

### Log Monitoring
- [ ] Check Vercel logs for errors
- [ ] Verify webhook processing times (< 5 seconds)
- [ ] Ensure no sensitive data in logs

### Error Scenarios
- [ ] Test with invalid webhook payload
- [ ] Test with missing customer data
- [ ] Test duplicate webhook delivery
- [ ] Verify 200 OK returned even on errors

---

## Monitoring in Production

### Set Up Alerts

Create alerts for:
1. **GDPR webhook failures** (status 500 responses)
2. **Long processing times** (> 10 seconds)
3. **Database transaction failures**
4. **Unprocessed requests** (status = "pending" for > 1 hour)

### Regular Audits

Monthly:
- Review GDPR request logs in database
- Verify all requests have status "completed"
- Check for any orphaned data
- Review error logs for patterns

Quarterly:
- Full data audit of all shops
- Verify data retention policies
- Test restore from backup
- Security vulnerability scan

---

## Troubleshooting

### Webhook Not Receiving Requests

**Check**:
1. Webhook URL is publicly accessible (not localhost)
2. Webhooks are registered: `shopify app config webhook list`
3. Firewall/WAF allows Shopify IPs
4. TLS certificate is valid

### Database Connection Issues

**Check**:
1. DATABASE_URL environment variable is set
2. Database allows connections from hosting provider IPs
3. Connection pool not exhausted
4. Prisma client is generated

### Data Not Deleting

**Check**:
1. Shop domain matches exactly (case-sensitive)
2. Database transaction completed
3. No foreign key constraints blocking deletion
4. Check application logs for errors

### GDPR Request Shows "Failed"

**Check**:
1. Review Vercel logs for the specific request
2. Verify database connection was active
3. Check if transaction rolled back
4. Manually investigate and remediate

---

## Compliance Checklist for App Store Submission

- [ ] All three GDPR webhooks implemented
- [ ] Webhooks return 200 OK within 5 seconds
- [ ] HMAC verification works correctly
- [ ] Data deletion is complete (no orphaned records)
- [ ] Audit trail maintained (GdprRequest table)
- [ ] Privacy Policy published and linked
- [ ] Terms of Service published and linked
- [ ] Compliance dashboard accessible to merchants
- [ ] Documentation provided for data retention

---

## Additional Resources

- **Shopify Webhook Documentation**: https://shopify.dev/docs/apps/webhooks
- **GDPR Compliance Guide**: https://shopify.dev/docs/apps/build/compliance/privacy-law-compliance
- **Testing Webhooks**: https://shopify.dev/docs/apps/tools/cli/commands#webhook-trigger
- **Mandatory Webhooks**: https://shopify.dev/docs/apps/webhooks/configuration/mandatory-webhooks

---

## Need Help?

If you encounter issues during testing:
1. Check the Vercel logs for detailed error messages
2. Review the database for partial deletions
3. Check the GdprRequest table for failed requests
4. Contact support: support@always-receptionist.com

**Remember**: All three GDPR webhooks MUST work correctly before your app can be approved for the Shopify App Store.
